<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Extending or modifying checks • pkgcheck</title>
<!-- rOpenSci favicons --><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Extending or modifying checks">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@v3.0.0/dist/cookieconsent.css">
<script src="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@v3.0.0/dist/cookieconsent.umd.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><p><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">
    <a href="https://ropensci.org" class="external-link"><img src="https://ropensci.org/img/icon_short_white.svg" id="hexlogo" alt="rOpenSci"></a>
    <a class="navbar-brand me-2" href="../index.html">pkgcheck</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.2.063</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"></ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/extending-checks.html">Extending or modifying checks</a></li>
    <li><a class="dropdown-item" href="../articles/list-checks.html">Current pkgcheck checks</a></li>
  </ul>
</li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ropensci-review-tools/pkgcheck/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Extending or modifying checks</h1>
                        <h4 data-toc-skip class="author">Mark
Padgham</h4>
            
            <h4 data-toc-skip class="date">2024-10-23</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci-review-tools/pkgcheck/blob/master/vignettes/extending-checks.Rmd" class="external-link"><code>vignettes/extending-checks.Rmd</code></a></small>
      <div class="d-none name"><code>extending-checks.Rmd</code></div>
    </div>

    
    
<p>This vignette describes how to modify or extend the existing suite of
checks implemented by <code>pkgcheck</code>. Each of the internal checks
is defined in a separate file in the <code>R</code> directory of this
package with the prefix of <code>check_</code> (or <code>checks_</code>
for files which define multiple, related checks). Checks only require
two main functions, the first defining the check itself, and the second
defining <code>summary</code> and <code>print</code> methods based on
the result of the first function. The check functions must have a prefix
<code>pkgchk_</code>, and the second functions defining output methods
specifying must have a prefix <code>output_pkgchk_</code>. These two
kind of function are now described in the following two sections.</p>
<p>Both of these functions must also accept a single input parameter of
a <code>pkgcheck</code> object, by convention named <code>checks</code>.
This object is a list of four main items:</p>
<ol style="list-style-type: decimal">
<li>
<code>pkg</code> which summarises data extracted from <a href="https://docs.ropensci.org/pkgstats/reference/pkgstats.html" class="external-link"><code>pkgstats::pkgstats()</code></a>,
and includes essential information on the package being checked.</li>
<li>
<code>info</code> which contains information used in checks,
including <code>info$git</code> detailing git repository information,
<code>info$pkgstats</code> containing a summary of a few statistics
generated from <a href="https://docs.ropensci.org/pkgstats/reference/pkgstats.html" class="external-link"><code>pkgstats::pkgstats()</code></a>,
along with statistical comparisons against distributions from all
current CRAN packages, an <code>info$network_file</code> specifying a
local directory to a <a href="https://visjs.org" class="external-link"><code>vis.js</code></a>
visualisation of the function call network of the package, and an
<code>info$badges</code> item containing information from GitHub
workflows and associated badges, where available.</li>
<li>
<code>checks</code> which contains a list of all objects returned
from all <code>pkgchk_...()</code> functions, which are used as input to
<code>output_pkgchk_...()</code> functions.</li>
<li>
<code>meta</code> containing a named character vector of versions of
the core packages used in <code>pkgcheck</code>.</li>
</ol>
<p><code>pkgcheck</code> objects generally also include a fifth item,
<code>goodpractice</code>, containing the results of <a href="https://github.com/MangoTheCat/goodpractice" class="external-link"><code>goodpractice</code>
checks</a>. The <code>checks</code> item passed to each
<code>pkgchk_...()</code> function contains all information on the
<code>package</code>, <code>info</code>, <code>meta</code>, and
(optionally) <code>goodpractice</code> items. Checks may use any of this
information, or even add additional information as demonstrated below.
The <code>checks$checks</code> list represents the output of check
functions, and may not be used in any way within
<code>pkgchk_...()</code> functions.</p>
<details><summary>
Click here to see structure of full <code>pkgcheck</code> object
</summary><p>
</p>
<p>This is the output of applying <code>pkgcheck</code> to a package
generated with the <a href="https://docs.ropensci.org/srr/reference/srr_stats_pkg_skeleton.html" class="external-link"><code>srr</code>
function <code>srr_stats_pkg_skeleton()</code></a>, with
<code>goodpractice = FALSE</code> to suppress that part of the
results.</p>
<pre><code><span><span class="co">#&gt; List of 4</span></span>
<span><span class="co">#&gt;  $ pkg   :List of 8</span></span>
<span><span class="co">#&gt;   ..$ name        : chr "dummypkg"</span></span>
<span><span class="co">#&gt;   ..$ path        : chr "/tmp/RtmpkguwJc/dummypkg"</span></span>
<span><span class="co">#&gt;   ..$ version     : chr "0.0.0.9000"</span></span>
<span><span class="co">#&gt;   ..$ url         : chr(0) </span></span>
<span><span class="co">#&gt;   ..$ BugReports  : chr(0) </span></span>
<span><span class="co">#&gt;   ..$ license     : chr "GPL-3"</span></span>
<span><span class="co">#&gt;   ..$ summary     :List of 12</span></span>
<span><span class="co">#&gt;   .. ..$ num_authors         : int 1</span></span>
<span><span class="co">#&gt;   .. ..$ num_vignettes       : int 0</span></span>
<span><span class="co">#&gt;   .. ..$ num_data            : int 0</span></span>
<span><span class="co">#&gt;   .. ..$ imported_pkgs       : int 1</span></span>
<span><span class="co">#&gt;   .. ..$ num_exported_fns    : int 1</span></span>
<span><span class="co">#&gt;   .. ..$ num_non_exported_fns: int 2</span></span>
<span><span class="co">#&gt;   .. ..$ num_src_fns         : int 2</span></span>
<span><span class="co">#&gt;   .. ..$ loc_exported_fns    : int 3</span></span>
<span><span class="co">#&gt;   .. ..$ loc_non_exported_fns: int 3</span></span>
<span><span class="co">#&gt;   .. ..$ loc_src_fns         : int 5</span></span>
<span><span class="co">#&gt;   .. ..$ num_params_per_fn   : int 0</span></span>
<span><span class="co">#&gt;   .. ..$ languages           : chr [1:2] "C++: 72%" "R: 28%"</span></span>
<span><span class="co">#&gt;   ..$ dependencies:'data.frame': 4 obs. of  2 variables:</span></span>
<span><span class="co">#&gt;   .. ..$ type   : chr [1:4] "depends" "imports" "suggests" "linking_to"</span></span>
<span><span class="co">#&gt;   .. ..$ package: chr [1:4] "NA" "Rcpp" "testthat" "Rcpp"</span></span>
<span><span class="co">#&gt;  $ info  :List of 5</span></span>
<span><span class="co">#&gt;   ..$ git         : list()</span></span>
<span><span class="co">#&gt;   ..$ srr         :List of 5</span></span>
<span><span class="co">#&gt;   .. ..$ message     : chr [1:108] "This package still has TODO standards and can not be submitted" "Package can not be submitted because the following standards [v0.1.0] are missing from your code:" "" "G1.0" ...</span></span>
<span><span class="co">#&gt;   .. ..$ categories  : chr "Regression and Supervised Learning"</span></span>
<span><span class="co">#&gt;   .. ..$ missing_stds: chr "G1.0, G1.4a, G1.6, G2.0a, G2.1a, G2.2, G2.3a, G2.3b, G2.4, G2.4a, G2.4b, G2.4c, G2.4d, G2.4e, G2.5, G2.6, G2.7,"| __truncated__</span></span>
<span><span class="co">#&gt;   .. ..$ report_file : chr "/home/smexus/.cache/pkgcheck/static/dummypkg_srr2021-10-15-16:46:34.html"</span></span>
<span><span class="co">#&gt;   .. ..$ okay        : logi FALSE</span></span>
<span><span class="co">#&gt;   ..$ pkgstats    :'data.frame': 25 obs. of  4 variables:</span></span>
<span><span class="co">#&gt;   .. ..$ measure   : chr [1:25] "files_R" "files_src" "files_vignettes" "files_tests" ...</span></span>
<span><span class="co">#&gt;   .. ..$ value     : num [1:25] 4 2 0 2 10 26 6 0 3 1 ...</span></span>
<span><span class="co">#&gt;   .. ..$ percentile: num [1:25] 23.284 77.356 0 64.15 0.445 ...</span></span>
<span><span class="co">#&gt;   .. ..$ noteworthy: chr [1:25] "" "" "TRUE" "" ...</span></span>
<span><span class="co">#&gt;   .. ..- attr(*, "language")= chr [1:2] "C++: 72%" "R: 28%"</span></span>
<span><span class="co">#&gt;   .. ..- attr(*, "files")= chr [1:2] "C++: 2" "R: 4"</span></span>
<span><span class="co">#&gt;   ..$ network_file: chr "/home/smexus/.cache/pkgcheck/static/dummypkg_pkgstats.html"</span></span>
<span><span class="co">#&gt;   ..$ badges      : list()</span></span>
<span><span class="co">#&gt;  $ checks:List of 12</span></span>
<span><span class="co">#&gt;   ..$ fns_have_exs     : Named logi FALSE</span></span>
<span><span class="co">#&gt;   .. ..- attr(*, "names")= chr "test_fn.Rd"</span></span>
<span><span class="co">#&gt;   ..$ has_bugs         : logi FALSE</span></span>
<span><span class="co">#&gt;   ..$ has_citation     : logi FALSE</span></span>
<span><span class="co">#&gt;   ..$ has_codemeta     : logi FALSE</span></span>
<span><span class="co">#&gt;   ..$ has_contrib_md   : logi FALSE</span></span>
<span><span class="co">#&gt;   ..$ has_scrap        : chr(0) </span></span>
<span><span class="co">#&gt;   ..$ has_url          : logi FALSE</span></span>
<span><span class="co">#&gt;   ..$ has_vignette     : logi FALSE</span></span>
<span><span class="co">#&gt;   ..$ left_assign      :List of 2</span></span>
<span><span class="co">#&gt;   .. ..$ global: logi FALSE</span></span>
<span><span class="co">#&gt;   .. ..$ usage : Named num [1:2] 2 0</span></span>
<span><span class="co">#&gt;   .. .. ..- attr(*, "names")= chr [1:2] "&lt;-" "="</span></span>
<span><span class="co">#&gt;   ..$ on_cran          : logi FALSE</span></span>
<span><span class="co">#&gt;   ..$ pkgname_available: logi TRUE</span></span>
<span><span class="co">#&gt;   ..$ uses_roxygen2    : logi TRUE</span></span>
<span><span class="co">#&gt;  $ meta  : Named chr [1:3] "0.0.2.25" "0.0.2.96" "0.0.1.120"</span></span>
<span><span class="co">#&gt;   ..- attr(*, "names")= chr [1:3] "pkgstats" "pkgcheck" "srr"</span></span>
<span><span class="co">#&gt;  - attr(*, "class")= chr [1:2] "pkgcheck" "list"</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre>

</details><div class="section level2">
<h2 id="the-check-function">1. The check function<a class="anchor" aria-label="anchor" href="#the-check-function"></a>
</h2>
<p>An example is the check for whether a package has a citation, <a href="https://github.com/ropensci-review-tools/pkgcheck/blob/main/R/check-has-citation.R" class="external-link">defined
in <code>R/check_has_citation.R</code></a>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Check whether a package has a `inst/CITATION` file.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' "CITATION" files are required for all rOpenSci packages, as documented [in</span></span>
<span><span class="co">#' our "*Packaging</span></span>
<span><span class="co">#' Guide*](https://devguide.ropensci.org/pkg_building.html#citation-file). This</span></span>
<span><span class="co">#' does not check the contents of that file in any way.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param checks A 'pkgcheck' object with full \pkg{pkgstats} summary and</span></span>
<span><span class="co">#' \pkg{goodpractice} results.</span></span>
<span><span class="co">#' @noRd</span></span>
<span><span class="va">pkgchk_has_citation</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">checks</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="st">"CITATION"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span> <span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span> <span class="op">(</span><span class="va">checks</span><span class="op">$</span><span class="va">pkg</span><span class="op">$</span><span class="va">path</span>, <span class="st">"inst"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This check is particularly simple, because a <code>"CITATION"</code>
file <a href="https://cran.r-project.org/doc/manuals/R-exts.html#CITATION-files" class="external-link">must
have exactly that name, and must be in the <code>inst</code>
sub-directory</a>. This function returns a simple logical of
<code>TRUE</code> if the expected <code>"CITATION"</code> file is
present, otherwise it returns <code>FALSE</code>. This function, and all
functions beginning with the prefix <code>pkgchk_</code>, will be
automatically called by the main <code><a href="../reference/pkgcheck.html">pkgcheck()</a></code> function, and
the value stored in <code>checks$checks$has_citation</code>. The name of
the item within the <code>checks$checks</code> list is the name of the
function with the <code>pkgchk_</code> prefix removed.</p>
<p>A more complicated example is the function to check whether a package
contains files which should not be there – internally called “scrap”
files. The check function itself, <a href="https://github.com/ropensci-review-tools/pkgcheck/blob/main/R/check-scrap.R" class="external-link">defined
in <code>R/check-scrap.R</code></a>, checks for the presence of files
matching an internally-defined list including files used to locally
cache folder thumbnails such as <code>".DS_Store"</code> or
<code>"Thumbs.db"</code>. The function returns a character vector of the
names of any “scrap” files which can be used by the <code>print</code>
method to provide details of files which should be removed. This
illustrates the first general principle of these check functions;
that,</p>
<div class="alert alert-info">
<ul>
<li><em>Any information needed when summarising or printing the check
result should be returned from the main check function.</em></li>
</ul>
</div>
<p>A second important principle is that,</p>
<div class="alert alert-info">
<ul>
<li>
<em>Check functions should never return <code>NULL</code>, rather
should always return an empty vector (such as
<code>integer(0)</code>)</em>.</li>
</ul>
</div>
<p>The following section considers how these return values from check
functions are converted to <code>summary</code> and <code>print</code>
output.</p>
</div>
<div class="section level2">
<h2 id="the-output-function">2. The output function<a class="anchor" aria-label="anchor" href="#the-output-function"></a>
</h2>
<p>All <code>output_pkgchk_...()</code> functions must also accept the
single input parameter of <code>checks</code>, in which the
<code>checks$checks</code> sub-list will already have been populated by
calling all <code>pkgchk_...()</code> functions described in the
previous section. The <code>pkgchk_has_citation()</code> function will
create an entry of <code>checks$checks$has_citation</code> which
contains the binary flag indicating whether or not a
<code>"CITATION"</code> file is present. Similarly, the <a href="https://github.com/ropensci-review-tools/pkgcheck/blob/main/R/check-scrap.R" class="external-link">the
<code>pkgchk_has_scrap()</code> function</a> will create
<code>checks$checks$has_scrap</code> which will contain names of any
scrap files present, and a length-zero vector otherwise.</p>
<p>The <code>output_pkgchk_has_citation()</code> function then looks
like this:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output_pkgchk_has_citation</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">checks</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span> <span class="op">(</span></span>
<span>        check_pass <span class="op">=</span> <span class="va">checks</span><span class="op">$</span><span class="va">checks</span><span class="op">$</span><span class="va">has_citation</span>,</span>
<span>        summary <span class="op">=</span> <span class="st">""</span>,</span>
<span>        print <span class="op">=</span> <span class="st">""</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># disabled:</span></span>
<span>    <span class="co"># https://github.com/ropensci-review-tools/pkgcheck/issues/115</span></span>
<span>    <span class="co"># out$summary &lt;- paste0 (</span></span>
<span>    <span class="co">#    ifelse (out$check_pass, "has", "does not have"),</span></span>
<span>    <span class="co">#    " a 'CITATION' file."</span></span>
<span>    <span class="co"># )</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span> <span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The first lines are common to all <code>output_pkgchk_...()</code>
functions, and define the generic return object. This object must be a
list with the following three items:</p>
<ol style="list-style-type: decimal">
<li>
<code>check_pass</code> as binary flag indicating whether or not a
check was passed;</li>
<li>
<code>summary</code> containing text used to generate the
<code>summary</code> output; and</li>
<li>
<code>print</code> containing information used to generate the
<code>print</code> output, itself a <code>list</code> of the following
items:
<ul>
<li>A <code>msg_pre</code> to display at the start of the
<code>print</code> result;</li>
<li>An <code>object</code> to be printed, such as a vector of values, or
a <code>data.frame</code>.</li>
<li>A <code>msg_post</code> to display at the end of the
<code>print</code> result following the <code>object</code>.</li>
</ul>
</li>
</ol>
<p><code>summary</code> and <code>print</code> methods may be suppressed
by assigning values of <code>""</code>. The above example of
<code>pkgcheck_has_citation</code> has <code>print = ""</code>, and so
no information from this check will appear as output of the
<code>print</code> method. The <code>summary</code> field is
commented-out in the current version, but left to illustrate here that
it has a value that is specified for both <code>TRUE</code> and
<code>FALSE</code> values of <code>check_pass</code>, via an
<code>ifelse</code> statement. The value is determined by the result of
the main <code>pkgchk_has_citation()</code> call, and is converted into
a green tick if <code>TRUE</code>, or a red cross if
<code>FALSE</code>.</p>
<p>Checks for which <code>print</code> information is desired require a
non-empty <code>print</code> item, as in the <a href="https://github.com/ropensci-review-tools/pkgcheck/blob/main/R/check-scrap.R" class="external-link"><code>output_pkgchk_has_scrap()</code>
function</a>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output_pkgchk_has_scrap</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">checks</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span> <span class="op">(</span></span>
<span>        check_pass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span> <span class="op">(</span><span class="va">checks</span><span class="op">$</span><span class="va">checks</span><span class="op">$</span><span class="va">has_scrap</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0L</span>,</span>
<span>        summary <span class="op">=</span> <span class="st">""</span>,</span>
<span>        print <span class="op">=</span> <span class="st">""</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">out</span><span class="op">$</span><span class="va">check_pass</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">out</span><span class="op">$</span><span class="va">summary</span> <span class="op">&lt;-</span> <span class="st">"Package contains unexpected files."</span></span>
<span>        <span class="va">out</span><span class="op">$</span><span class="va">print</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span> <span class="op">(</span></span>
<span>            msg_pre <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span> <span class="op">(</span></span>
<span>                <span class="st">"Package contains the "</span>,</span>
<span>                <span class="st">"following unexpected files:"</span></span>
<span>            <span class="op">)</span>,</span>
<span>            obj <span class="op">=</span> <span class="va">checks</span><span class="op">$</span><span class="va">checks</span><span class="op">$</span><span class="va">has_scrap</span>,</span>
<span>            msg_post <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span> <span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span> <span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>In this case, both <code>summary</code> and <code>print</code>
methods are only triggered <code>if (!out$check_pass)</code> – so only
if the check fails. The <code>print</code> method generates the heading
specified in <code>out$print$msg_pre</code>, with any vector-valued
objects stored in the corresponding <code>obj</code> list item displayed
as formatted lists. A package with “scrap” files, <code>"a"</code> and
<code>"b"</code>, would thus have
<code>out$print$obj &lt;- c ("a", "b")</code>, and when printed would
look like this:</p>
<pre><code><span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Package contains the following unexpected files:</span></span>
<span><span class="co">#&gt; • a</span></span>
<span><span class="co">#&gt; • b</span></span></code></pre>
<p>This formatting is also translated into corresponding markdown and
HTML formatting in <a href="https://github.com/ropensci-review-tools/pkgcheck/blob/main/R/format-checks.R" class="external-link">the
<code>checks_to_markdown()</code> function</a>.</p>
<p>The design of these <code>pkgchk_</code> and
<code>output_pkgchk_</code> functions aims to make the package readily
extensible, and we welcome discussions about developing new checks. The
primary criterion for new package-internal checks is that they must be
of very general applicability, in that they should check for a condition
that <em>almost</em> every package should or should not meet.</p>
<p>The package also has a mechanism to easily incorporate more specific,
locally-defined checks, as explored in the following section.</p>
</div>
<div class="section level2">
<h2 id="creating-new-checks">3. Creating new checks<a class="anchor" aria-label="anchor" href="#creating-new-checks"></a>
</h2>
<div class="section level3">
<h3 id="new-local-checks-for-package-users">3.1 New Local Checks (<em>for package users</em>)<a class="anchor" aria-label="anchor" href="#new-local-checks-for-package-users"></a>
</h3>
<p>The <a href="https://docs.ropensci.org/pkgcheck/reference/pkgcheck.html">main
<code>pkgcheck()</code> function</a> has an additional parameter,
<code>extra_env</code> which specifies,</p>
<blockquote>
<p>Additional environments from which to collate checks. Other package
names may be appended using c, as in c(.GlobalEnv, “mypkg”).</p>
</blockquote>
<p>This allows specific checks to be defined locally, and run by passing
the name of the environment in which those checks are defined in this
parameter. This section illustrates the process using the bundled
“tarball” (that is, <code>.tar.gz</code> file) of one version of <a href="https://github.com/ropensc-review-tools/pkgstats" class="external-link">the
<code>pkgstats</code> package</a> included with that package.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span> <span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"pkgstats_9.9.tar.gz"</span>, package <span class="op">=</span> <span class="st">"pkgstats"</span><span class="op">)</span></span>
<span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu">pkgstats</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/pkgstats/reference/extract_tarball.html" class="external-link">extract_tarball</a></span> <span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span><span class="va">checks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pkgcheck.html">pkgcheck</a></span> <span class="op">(</span><span class="va">path</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span> <span class="op">(</span><span class="va">checks</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">pkgstats 9.9</span> <span style="color: #00BBBB;">────────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Package name is available</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> does not have a 'codemeta.json' file.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> does not have a 'contributing' file.</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> uses 'roxygen2'.</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> 'DESCRIPTION' has a URL field.</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> 'DESCRIPTION' has a BugReports field.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Package has no HTML vignettes</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> These functions do not have examples: [pkgstats_from_archive].</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Package has continuous integration checks.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Package coverage failed</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> R CMD check found 1 error.</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> R CMD check found no warnings.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Current status:</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> This package is not ready to be submitted.</span></span></code></pre>
<p>Let’s now presume I have a reputation in the R community for all of
my packages starting with “aa”, to ensure they are always listed first.
This section demonstrates how to implement a check that only passes if
the first two letters of the package name are “aa”. The first step
described above is to define the check itself via a function prefixed
with <code>pkgchk_</code>. The easiest approach would be for the
<code>pkgcheck_</code> function to directly check the name, and return a
logical flag indicating whether or not the same starts with “aa”. The
resultant <code>summary</code> and <code>print</code> methods can,
however, only use the information provided by the initial
<code>pkgchk_</code> function. That means if we want to print the actual
name in the result of either of those functions, to show that it indeed
does not form the desired patter, we need to return that information.
The check function is then simply:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pkgchk_starts_with_aa</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">checks</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">checks</span><span class="op">$</span><span class="va">pkg</span><span class="op">$</span><span class="va">name</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We then need to define the output functions:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output_pkgchk_starts_with_aa</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">checks</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span> <span class="op">(</span></span>
<span>                 check_pass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span> <span class="op">(</span><span class="st">"^aa"</span>,</span>
<span>                                     <span class="va">checks</span><span class="op">$</span><span class="va">checks</span><span class="op">$</span><span class="va">starts_with_aa</span>,</span>
<span>                                     ignore.case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                 summary <span class="op">=</span> <span class="st">""</span>,</span>
<span>                 print <span class="op">=</span> <span class="st">""</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="va">out</span><span class="op">$</span><span class="va">summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span> <span class="op">(</span><span class="st">"Package name ["</span>,</span>
<span>                           <span class="va">checks</span><span class="op">$</span><span class="va">checks</span><span class="op">$</span><span class="va">starts_with_aa</span>,</span>
<span>                           <span class="st">"] does "</span>,</span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span> <span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">check_pass</span>,</span>
<span>                                   <span class="st">""</span>,</span>
<span>                                   <span class="st">"NOT"</span><span class="op">)</span>,</span>
<span>                           <span class="st">" start with 'aa'"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span> <span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>If we simply define those function in the global workspace of our
current R session, calling <code><a href="../reference/pkgcheck.html">pkgcheck()</a></code> again will
automatically detect those checks and include them in our output:</p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">pkgstats 9.9</span> <span style="color: #00BBBB;">────────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Package name is available</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> does not have a 'codemeta.json' file.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> does not have a 'contributing' file.</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> uses 'roxygen2'.</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> 'DESCRIPTION' has a URL field.</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> 'DESCRIPTION' has a BugReports field.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Package has no HTML vignettes</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> These functions do not have examples: [pkgstats_from_archive].</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Package has continuous integration checks.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Package coverage failed</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Package name [pkgstats] does NOT start with 'aa'</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> R CMD check found 1 error.</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> R CMD check found no warnings.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Current status:</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> This package is not ready to be submitted.</span></span></code></pre>
<p>Customised personal checks can be incorporated by defining them in a
local package, loading that into the workspace, and passing the name of
the package to the <code>extra_env</code> parameter.</p>
</div>
<div class="section level3">
<h3 id="new-pkgcheck-checks-for-pkgcheck-developers">3.2 New <code>pkgcheck</code> Checks (<em>for <code>pkgcheck</code>
developers</em>)<a class="anchor" aria-label="anchor" href="#new-pkgcheck-checks-for-pkgcheck-developers"></a>
</h3>
<p>New checks can be added to this package by creating new files in the
<code>/R</code> directory prefixed with <code>pkgchk_</code>, and
including the two functions described above (a check and an output
function). The check name will then need to be included in <a href="https://github.com/ropensci-review-tools/pkgcheck/blob/6c99a804cea99af4fca8e27e41784ecd6b7f1501/R/summarise-checks.R#L92-L114" class="external-link">the
<code>order_checks()</code> function in the
<code>R/summarise-checks.R</code> file</a>, which determines the order
of checks in the <code>summary</code> output. Checks which are not
defined in this ordering, including any defined via
<code>extra_env</code> parameters, appear <em>after</em> all of the
standard checks, and prior to the <code>R CMD check</code> results which
always appear last. This order may only be modified by editing the list
in that function. The order of check results in the <code>print</code>
method is also hard-coded, defined in the <a href="https://github.com/ropensci-review-tools/pkgcheck/blob/main/R/pkgcheck-methods.R" class="external-link">main
<code>print.pkgcheck</code> method</a>. As explicitly stated in that
function, any new checks should also be included in the
<code>print</code> method just after <a href="https://github.com/ropensci-review-tools/pkgcheck/blob/2e025c276c84b45bc46f72ec5d8b029de83ac211/R/pkgcheck-methods.R#L65-L71" class="external-link">the
first reference to <code>"misc_checks"</code></a>, via an additional
line:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">print_check_screen</span> <span class="op">(</span><span class="va">x</span>, <span class="st">"&lt;name-of-new-check&gt;"</span>, <span class="va">pkg_env</span><span class="op">)</span></span></code></pre></div>
<p>The <code>print_check_screen()</code> function will then
automatically activate the <code>print</code> method of any new checks.
This line should be added even if a new check has no <code>print</code>
method (as in the <code>starts_with_aa</code> example above), to provide
an explicit record of all internally-defined miscellaneous checks.</p>
<p>Finally, any new checks also need to be included in tests. The test
suites run on generic, mostly empty packages constructed with <a href="https://docs.ropensci.org/srr/reference/srr_stats_pkg_skeleton.html" class="external-link">the
<code>srr::srr_stats_pkg_skeleton()</code> function</a>, as in the <a href="https://github.com/ropensci-review-tools/pkgcheck/blob/main/tests/testthat/test-pkgcheck.R" class="external-link">main
<code>test-pkgcheck.R</code> test functions</a>. Additional tests are
also performed on the <code>pkgstats</code> tarball illustrated above.
The default results of any new checks will be automatically tested by
the existing test suite, but it is important to test all potential
results. The <a href="https://github.com/ropensci-review-tools/pkgcheck/blob/main/tests/testthat/test-extra-checks.R" class="external-link"><code>test-extra-checks.R</code>
file</a> is the main location for testing additional tests, with lines
in that file demonstrating how the main results can be readily modified
to reflect alternative outputs of check functions (such as
<code>pkgchk_has_scrap</code> and
<code>pkgchk_obsolete_pkg_deps</code>). The output functions defined as
part of checks, including any new checks, do not need to be explicitly
tested, as the entire output is tested via <a href="https://testthat.r-lib.org/articles/snapshotting.html" class="external-link"><code>testthat</code>
snapshots</a>. Snapshot results need to be updated to reflect any
additional tests. Finally, the <a href="https://github.com/ropensci-review-tools/pkgcheck/blob/main/tests/testthat/test-list-checks.R" class="external-link"><code>test-list-checks.R</code>
file</a> tests the total number of internally-defined checks as
<code>expect_length (ncks, ..)</code>. The number tested there also
needs to be incremented by one for each new check.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="https://ropensci.org/img/icon_short_white.svg">
</div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://github.com/ropenscilabs" target="_blank" class="external-link"><div class="icon fa fa-flask"></div></a>
                        <a href="https://hachyderm.io/@ropensci" target="_blank" class="external-link"><div class="icon fab fa-mastodon"></div></a>
                        <a href="https://vimeo.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-vimeo"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://ropensci.org/about" class="external-link">About rOpenSci</a></li>
                            <li><a href="https://ropensci.org/software-review" class="external-link">Software Review</a></li>
                            <li><a href="https://ropensci.org/about#team" class="external-link">Our Team</a></li>
                            <li><a href="https://ropensci.org/careers" class="external-link">Jobs</a></li>
                            <li><a href="https://ropensci.org/donate" class="external-link">Donate</a></li>
                            <li><a href="https://ropensci.org/contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-3 col-sm-4">
                        <ul>
<h5 class="bottom-2">Community</h5>
                            <li><a href="https://ropensci.org/community/" class="external-link">Our Community</a></li>
                            <li><a href="https://ropensci.org/commcalls/" class="external-link">Community calls</a></li>
                            <li><a href="https://ropensci.org/events/" class="external-link">Events</a></li>
                            <li><a href="https://discuss.ropensci.org/" class="external-link">Join the Discussion</a></li>
                            <li><a href="https://ropensci.org/code-of-conduct" class="external-link">Code of conduct</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://ropensci.org/packages/" class="external-link">Packages</a></li>
                            <li><a href="https://ropensci.org/usecases/" class="external-link">Use Cases</a></li>
                            <li><a href="https://ropensci.org/talks-papers/" class="external-link">Talks &amp; Publications</a></li>
                            <li><a href="https://docs.ropensci.org/" class="external-link">Documentation</a></li>
                            <li><a href="https://ropensci.org/news/" class="external-link">Newsletter</a></li>
                            <li><a href="https://ropensci.org/how-to-cite-ropensci/" class="external-link">Cite rOpenSci</a></li>
                        </ul>
</div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" class="external-link">NumFOCUS</a>.</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->


    </footer>
</div>





  </body>
</html>
